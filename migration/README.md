# Old Logger Migration Utility

This tool is intended to assist with migration from old logger system which uses Microsoft SQL server and stores recordings in WMA or WAV format. The script will query MS SQL for all recordings in the specified date range and begin the process of converting all the recordings to MP3. Once completed, a cdr-csv file is generated that the logger cron service will pick up and insert in the database.

## Tips before you begin

### Disable cron

Before beginning it is important to turn off cron. This is because cron runs once a minute and it is possible that it will take longer than a minute to import all of the data into MySQL that is generated by the migration script. To temporarily turn off cron run the following command:

`service cron stop`

### Run as root

The migration script needs to make changes to restricted files, run the script as root to avoid any problems

### Run multiple instances simultaneously

The migration script is single threaded, meaning that only one stream of files is being converted at a time. This only uses one processor core. It is ideal to have 1 or 2 instances of the conversion script running PER CORE, assuming you have allocated enough RAM to load the database entries into RAM for each instance. It is recommended that 1GB/RAM per instance is allocated.

To run multiple instances it is recommended to use a utility like **screen** to provide virtual disconnectable terminals to each instance. This will allow the migration execution to continue processing in the event you are disconnected from the terminal or if you need to disconnect your computer from the network. The conversion process can last several days depending on the number of recordings.

To use screen to run multiple instances execute the screen commands as such:

    screen -d -m python logger-migrate.py --start=2016/10/01 --end=2016/10/31
    screen -d -m python logger-migrate.py --start=2016/09/01 --end=2016/09/31
    screen -d -m python logger-migrate.py --start=2016/08/01 --end=2016/08/30
    screen -d -m python logger-migrate.py --start=2016/07/01 --end=2016/07/31

This will invoke 4 screen sessions and execute the commands in separate, disconnectable virtual sessions. 

## Configuration

The migration script needs some configuration prior to execution.

At a minimum, the following variables should be modified to match your existing environment:

Variable | Description
--- | ---
dbserver | The Microsoft SQL server that contains call recording data
dbusername | The username used to connect to the Microsoft SQL server
dbpassword | The password used to connect to the Microsoft SQL server
dbdatabase | The database on the Microsoft SQL servet that contains call recording data
stripstring | This is the escaped substring of the 'AudioFilePath' field to search for. The data after this substring is considered the folder and file where the recording is stored. For example, if the 'AudioFilePath' field is set to 'C:\UMPlatform\logger\2016-10-01\2345236-30.wma' then we know everything before 'logger\' is the base path, and everything after 'logger\' is the file location. So we would set this to 'logger\\' to escape the backslash.
sourceloc | Location on the filesystem where you have mounted the SMB share where the recordings are stored. Be sure this folder leads to the location where all of the date folders reside (2016-10-01, 2016-10-02, etc.)

The following optional variables can be set if desired:

Variable | Description
--- | ---
destloc | If your recordings are in a location other than the default location, set this
cdrloc | If your cdr-csv files are located in a location other than the default location, set this
mailnotify | Set to **True** or **False** (case sensitive) if you wish to receive email notification when the script completes. This can be useful for long running scripts
notifyfrom | If mailnotify is set to **True**, set this email address to be the **From:** email address
notifyto | If mailnotify is set to **True**, set this email address to be the **To:** email address
smtpserver | The IP address or domain name of your SMTP server. Note that SMTP authentication is not currently supported
fsuid | If FreeSWITCH is running as a user other than 'freeswitch' set it here
fsgid | If FreeSWITCH is running as a group other than 'freeswitch' set it here

## Post migration tasks

After you have migrated all date ranges you wish to migrate, run the **cdr-rotate** program to start the process of importing all of the data into your MySQL database. This will take quite a bit of time depending on how many recording entries you have:

`/usr/local/bin/cdr-rotate`

Once this has completed, restart cron to continue normal operation:

`service cron restart`

